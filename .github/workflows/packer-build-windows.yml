name: Build and Deploy Packer Image

on:
  workflow_dispatch:
    inputs:
      os_type:
        description: 'Select OS and version'
        required: true
        default: 'ubuntu-22.04'
        type: choice
        options:
          - ubuntu-22.04
          - windows-2022

jobs:
  packer-build:
    runs-on: ${{ startsWith(github.event.inputs.os_type, 'windows') && fromJson('["self-hosted","Windows"]') || fromJson('["self-hosted","ubuntu"]') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Packer installation (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: |
            packer --version

      - name: Set image variables (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        id: set_vars_ubuntu
        shell: bash
        run: |
          OS_TYPE="${{ github.event.inputs.os_type }}"
          VERSION="${OS_TYPE#ubuntu-}"
          echo "PACKER_FILE=packer-vsphere/ubuntu/ubuntu-${VERSION}.pkr.hcl" >> $GITHUB_OUTPUT
          echo "VAR_FILES=packer-vsphere/ubuntu/variables.pkrvars100GBdisk.hcl packer-vsphere/ubuntu/vsphere.pkrvars.hcl" >> $GITHUB_OUTPUT

      - name: Set image variables (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        id: set_vars_windows
        shell: powershell
        run: |
          $OS_TYPE = "${{ github.event.inputs.os_type }}"
          $VERSION = $OS_TYPE -replace 'windows-',''
          Write-Output "PACKER_FILE=packer-vsphere/windows/windows$VERSION.pkr.hcl" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Output "VAR_FILES=packer-vsphere/windows/windows$VERSION.auto.pkrvars.hcl" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Debug file existence (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: |
          Write-Host "Listing files in packer-vsphere/windows:"
          Get-ChildItem -Recurse packer-vsphere\windows
          Write-Host "\nFirst 20 lines of template file ($env:PACKER_FILE):"
          if (Test-Path $env:PACKER_FILE) {
            Get-Content $env:PACKER_FILE -First 20
          } else {
            Write-Host "Template file not found!"
          }
          Write-Host "\nFirst 20 lines of var-file ($env:VAR_FILES):"
          if (Test-Path $env:VAR_FILES) {
            Get-Content $env:VAR_FILES -First 20
          } else {
            Write-Host "Var-file not found!"
          }
          
      - name: Build Packer image (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        env:
          VSPHERE_USER: ${{ secrets.VSPHERE_USER }}
          VSPHERE_PASSWORD: ${{ secrets.VSPHERE_PASSWORD }}
          VSPHERE_SERVER: ${{ secrets.VSPHERE_SERVER }}
          WINADMIN_PASSWORD: ${{ secrets.WINADMIN_PASSWORD }}
        run: |
          $packerArgs = @('build', '-force')

          # var-file(s)
          if ($env:VAR_FILES) {
            foreach ($file in $env:VAR_FILES.Split(" ")) {
              if ($file) { $packerArgs += @('-var-file', $file) }
            }
          }

          # IMPORTANT: -var must be two args: -var "key=value"
          # Also IMPORTANT: variable names should use underscores in HCL: vsphere_user, etc.
          $packerArgs += @('-var', "vsphere-user=$env:VSPHERE_USER")
          $packerArgs += @('-var', "vsphere-password=$env:VSPHERE_PASSWORD")
          $packerArgs += @('-var', "vsphere-server=$env:VSPHERE_SERVER")
          $packerArgs += @('-var', "winadmin-password=$env:WINADMIN_PASSWORD")

          # Template file
          $packerArgs += $env:PACKER_FILE

          Write-Host "Running: packer init $env:PACKER_FILE"
          packer init $env:PACKER_FILE

          Write-Host "Running: packer $($packerArgs -join ' ')"
          & packer @packerArgs

