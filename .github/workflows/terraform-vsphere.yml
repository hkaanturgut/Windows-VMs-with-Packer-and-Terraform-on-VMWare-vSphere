name: Terraform vSphere Deploy

on:
  workflow_dispatch:
    inputs:
      run_apply:
        description: 'Run terraform apply?'
        required: false
        default: false
        type: boolean
      os_type:
        description: 'Select OS and version'
        required: true
        default: 'windows-2022'
        type: choice
        options:
          - ubuntu-22.04
          - windows-2022

jobs:
  terraform:
    # Windows -> self-hosted Windows runner
    # Ubuntu  -> self-hosted Linux runner (label is usually "Linux")
    runs-on: ${{ startsWith(github.event.inputs.os_type, 'windows')
      && fromJson('["self-hosted","Windows","X64"]')
      || fromJson('["self-hosted","Linux","X64"]') }}

    env:
      VSPHERE_USER: ${{ secrets.VSPHERE_USER }}
      VSPHERE_PASSWORD: ${{ secrets.VSPHERE_PASSWORD }}
      VSPHERE_SERVER: ${{ secrets.VSPHERE_SERVER }}
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TF_VAR_vsphere_user: ${{ secrets.VSPHERE_USER }}
      TF_VAR_vsphere_password: ${{ secrets.VSPHERE_PASSWORD }}
      TF_VAR_vsphere_server: ${{ secrets.VSPHERE_SERVER }}
      TF_VAR_windows_admin_username: ${{ secrets.WINDOWS_ADMIN_USERNAME }}
      TF_VAR_windows_admin_password: ${{ secrets.WINDOWS_ADMIN_PASSWORD }}

    defaults:
      run:
        # Use bash on Linux, powershell on Windows (per-step overrides below)
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Terraform (recommended even on self-hosted so versions are consistent)
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      # -------- Debug / sanity checks --------
      - name: Debug (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: |
          echo "Runner OS: $RUNNER_OS"
          terraform version
          which terraform
          echo "PATH=$PATH"
          echo "Workspace: $(pwd)"
          ls -la

      - name: Debug (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: |
          Write-Host "Runner OS: $env:RUNNER_OS"
          terraform version
          Get-Command terraform | Format-List *
          Write-Host "PATH:"
          Write-Host $env:PATH
          Write-Host "Workspace: $pwd"
          Get-ChildItem -Force
      
      # -------- Terraform Cloud Credentials --------
      - name: Configure Terraform Cloud credentials (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: |
          mkdir -p ~/.terraform.d
          cat > ~/.terraform.d/credentials.tfrc.json <<EOF
          {
            "credentials": {
              "app.terraform.io": {
                "token": "${TF_API_TOKEN}"
              }
            }
          }
          EOF

      - name: Configure Terraform Cloud credentials (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: |
          $dir = Join-Path $env:APPDATA "terraform.d"
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          $path = Join-Path $dir "credentials.tfrc.json"
          $json = @"
          {
            "credentials": {
              "app.terraform.io": {
                "token": "$($env:TF_API_TOKEN)"
              }
            }
          }
          "@
          $json | Out-File -FilePath $path -Encoding ascii
          Write-Host "Terraform Cloud credentials file created at: $path"

      # -------- Terraform Init --------
      - name: Terraform Init (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: terraform init -no-color

      - name: Terraform Init (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: terraform init -no-color

      # -------- Terraform Validate --------
      - name: Terraform Validate (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: terraform validate -no-color

      - name: Terraform Validate (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: terraform validate -no-color

      # -------- Terraform Plan --------
      - name: Terraform Plan (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: terraform plan -no-color -out=tfplan

      - name: Terraform Plan (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: terraform plan -no-color -out=tfplan

      # Show the plan contents (this is what you were “missing”)
      - name: Show Plan (Ubuntu)
        if: startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: |
          echo "----- BEGIN TF PLAN (tfplan) -----"
          terraform show -no-color tfplan
          echo "----- END TF PLAN (tfplan) -----"

      - name: Show Plan (Windows)
        if: startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: |
          Write-Host "----- BEGIN TF PLAN (tfplan) -----"
          terraform show -no-color tfplan
          Write-Host "----- END TF PLAN (tfplan) -----"

      # -------- Terraform Apply (optional) --------
      - name: Terraform Apply (Ubuntu)
        if: github.event.inputs.run_apply == true && startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: terraform apply -no-color -auto-approve tfplan

      - name: Terraform Apply (Windows)
        if: github.event.inputs.run_apply == true && startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: terraform apply -no-color -auto-approve tfplan

      # -------- Outputs (only if apply ran) --------
      - name: Show Terraform Outputs (Ubuntu)
        if: github.event.inputs.run_apply == true && startsWith(github.event.inputs.os_type, 'ubuntu')
        shell: bash
        run: |
          echo "--- BEGIN TERRAFORM OUTPUT ---"
          terraform output -no-color || true
          echo "--- END TERRAFORM OUTPUT ---"

      - name: Show Terraform Outputs (Windows)
        if: github.event.inputs.run_apply == true && startsWith(github.event.inputs.os_type, 'windows')
        shell: powershell
        run: |
          Write-Host "--- BEGIN TERRAFORM OUTPUT ---"
          terraform output -no-color
          Write-Host "--- END TERRAFORM OUTPUT ---"
